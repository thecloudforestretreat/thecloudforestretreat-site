<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacto | The Cloud Forest Retreat</title>
  <meta name="description" content="Contacta a The Cloud Forest Retreat cerca de Quito, Ecuador. Consulta disponibilidad, habitaciones, cómo llegar y experiencias de naturaleza cercanas. Respondemos rápido." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://thecloudforestretreat.com/contact/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="The Cloud Forest Retreat" />
  <meta property="og:title" content="Contacto | The Cloud Forest Retreat" />
  <meta property="og:description" content="Contacta a The Cloud Forest Retreat cerca de Quito, Ecuador. Consulta disponibilidad, habitaciones, cómo llegar y experiencias de naturaleza cercanas. Respondemos rápido." />
  <meta property="og:url" content="https://thecloudforestretreat.com/contact/" />
  <meta property="og:image" content="https://staging.thecloudforestretreat.com/og-tcfr.jpg" />
  <meta property="og:image:secure_url" content="https://staging.thecloudforestretreat.com/og-tcfr.jpg" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="The Cloud Forest Retreat en Mindo, Ecuador" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Contacto | The Cloud Forest Retreat" />
  <meta name="twitter:description" content="Contacta a The Cloud Forest Retreat cerca de Quito, Ecuador. Consulta disponibilidad, habitaciones, cómo llegar y experiencias de naturaleza cercanas. Respondemos rápido." />
  <meta name="twitter:image" content="https://staging.thecloudforestretreat.com/og-tcfr.jpg" />
  <link rel="icon" href="/favicon.ico" sizes="any" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <meta name="theme-color" content="#0D5925" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/site.css" />
  <link rel="stylesheet" href="/assets/css/header.css" />
  <script>
document.addEventListener("DOMContentLoaded", function () {
  var form = document.getElementById("tcfrContactForm");
  if (!form) return;

  var btn = document.getElementById("tcfrSubmitBtn");
  var statusCard = document.getElementById("tcfrContactStatusCard");
  var statusTitle = document.getElementById("tcfrContactStatusTitle");
  var statusMsg = document.getElementById("tcfrContactStatusMsg");

  var firstNameEl = form.querySelector('[name="first_name"]');
  var lastNameEl = form.querySelector('[name="last_name"]');
  var messageEl = form.querySelector('[name="message"]');
  var turnstileEl = form.querySelector('[name="cf-turnstile-response"]');

  function capFirstOnly(s) {
    s = String(s || "").trim();
    if (!s) return "";
    return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
  }

  function capMessageFirstLetter(s) {
    s = String(s || "");
    var t = s.replace(/^\s+/, "");
    if (!t) return "";
    return t.charAt(0).toUpperCase() + t.slice(1);
  }

  function normalizeInputs() {
    if (firstNameEl) firstNameEl.value = capFirstOnly(firstNameEl.value);
    if (lastNameEl) lastNameEl.value = capFirstOnly(lastNameEl.value);
    if (messageEl) messageEl.value = capMessageFirstLetter(messageEl.value);
  }

  if (firstNameEl) firstNameEl.addEventListener("blur", function () { firstNameEl.value = capFirstOnly(firstNameEl.value); });
  if (lastNameEl) lastNameEl.addEventListener("blur", function () { lastNameEl.value = capFirstOnly(lastNameEl.value); });
  if (messageEl) messageEl.addEventListener("blur", function () { messageEl.value = capMessageFirstLetter(messageEl.value); });

  function showStatus(kind, title, msg) {
    if (!statusCard || !statusTitle || !statusMsg) return;
    statusCard.classList.remove("show", "success", "error");
    statusCard.classList.add("show", kind);
    statusTitle.textContent = title;
    statusMsg.textContent = msg;
    statusCard.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function setLoading(isLoading) {
    if (!btn) return;
    btn.disabled = !!isLoading;
    btn.textContent = isLoading ? "Enviando..." : "Enviar";
  }

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    e.stopPropagation();

    normalizeInputs();

    var token = turnstileEl ? String(turnstileEl.value || "").trim() : "";
    if (!token) {
      showStatus(
        "error",
        "Verificacion requerida",
        "Por favor completa el captcha y vuelve a intentar."
      );
      return;
    }

    var fd = new FormData(form);
    var payload = {
      cf_secret: fd.get("cf_secret") || "",
      "cf-turnstile-response": token,
      first_name: fd.get("first_name") || "",
      last_name: fd.get("last_name") || "",
      email: fd.get("email") || "",
      phone: fd.get("phone") || "",
      message: fd.get("message") || "",
      how_did_you_hear_about_us: fd.get("how_did_you_hear_about_us") || "",
      source_page: window.location.pathname || "/es/contacto/",
      user_agent: navigator.userAgent || "",
      ip_best_effort: "",
      lang: "es"
    };

    setLoading(true);

    try {
      var res = await fetch("/api/contact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      var data = null;
      try { data = await res.json(); } catch (err) { data = null; }

      if (!res.ok || !data || data.ok !== true) {
        var msg = (data && data.message) ? String(data.message) : "No se pudo enviar. Intenta de nuevo.";
        showStatus("error", "No se pudo enviar", msg);
        setLoading(false);
        return;
      }

      form.reset();

      if (window.turnstile && typeof window.turnstile.reset === "function") {
        try { window.turnstile.reset(); } catch (err2) {}
      }

      showStatus(
        "success",
        "Mensaje enviado",
        "Gracias. Recibimos tu mensaje y te enviamos un email de confirmacion. Si no lo ves, revisa spam o promociones."
      );

      setLoading(false);

    } catch (err) {
      showStatus("error", "No se pudo enviar", "Error de red. Por favor intenta de nuevo.");
      setLoading(false);
    }
  });
});
</script>
</body>
</html>
